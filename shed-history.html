<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Rehman Poultry Farm 29/11L - Shed History</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; background: #f4f8fb; margin:20px; }
  h1, h2 { text-align:center; color:#2c3e50; margin:5px; }
  .filters { text-align:center; margin-bottom:20px; }
  .filters label { margin: 0 5px; font-weight:600; }
  select, input[type=date] { padding:6px 10px; font-size:1rem; }
  table { width:100%; border-collapse:collapse; margin-top:15px; }
  th, td { border:1px solid #ccc; padding:8px; text-align:center; }
  th { background:#3498db; color:#fff; }
  tr:nth-child(even) { background:#ecf0f1; }
  .summary { text-align:center; margin-top:10px; font-size:1.1rem; color:#555; }
  #downloadBtn { display:block; margin:20px auto; padding:10px 20px; background:#27ae60; color:#fff; border:none; border-radius:20px; cursor:pointer; font-weight:bold; }
</style>
</head>
<body>

<h1>Rehman Poultry Farm 29/11L</h1>
<h2 id="shedTitle">Shed No. --</h2>

<div class="filters">
  <label for="date">Date:</label>
  <input type="date" id="date" />
  <label for="interval">Interval:</label>
  <select id="interval">
    <option value="5">5 Minute</option>
    <option value="10">10 Minute</option>
    <option value="15">15 Minute</option>
    <option value="30">30 Minute</option>
    <option value="60" selected>1 Hour</option>
  </select>
</div>

<div class="summary">
  ðŸ”´ High Temp: <strong id="highTemp">-</strong> Â°C &nbsp; | &nbsp;
  ðŸ”µ Low Temp: <strong id="lowTemp">-</strong> Â°C
</div>

<button id="downloadBtn">ðŸ“„ Download PDF</button>

<table>
  <thead>
    <tr><th>Time</th><th>Temperature</th><th>Humidity</th><th>Avg Temperature</th><th>Avg Humidity</th></tr>
  </thead>
  <tbody id="tbody">
    <tr><td colspan="5">Loading data...</td></tr>
  </tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
<script>
  const channelId = '3006164'; // Replace with your public ThingSpeak channel ID
  const shedName = 'Shed 29/11L';

  const shedTitle = document.getElementById('shedTitle');
  const dateInput = document.getElementById('date');
  const intervalSelect = document.getElementById('interval');
  const tbody = document.getElementById('tbody');
  const highTempEl = document.getElementById('highTemp');
  const lowTempEl = document.getElementById('lowTemp');
  const downloadBtn = document.getElementById('downloadBtn');

  shedTitle.textContent = `${shedName} - --`;
  dateInput.value = new Date().toISOString().split('T')[0];
  shedTitle.textContent = `${shedName} - ${dateInput.value}`;

  dateInput.addEventListener('change', () => {
    shedTitle.textContent = `${shedName} - ${dateInput.value}`;
    fetchAndRender();
  });
  intervalSelect.addEventListener('change', fetchAndRender);
  downloadBtn.addEventListener('click', downloadPDF);

  async function fetchData() {
    const dateVal = dateInput.value;
    if (!dateVal) return [];

    tbody.innerHTML = '<tr><td colspan="5">Loading data...</td></tr>';

    // Pakistan Time is UTC+5; convert date start/end in PKT to UTC ISO for ThingSpeak query
    const startPKT = new Date(dateVal + 'T00:00:00+05:00');
    const endPKT = new Date(dateVal + 'T23:59:59+05:00');

    // Convert PKT to UTC ISO string (remove trailing Z to avoid timezone confusion)
    function toUTCISOStringNoZ(d) {
      const utc = new Date(d.getTime() - d.getTimezoneOffset()*60000);
      return utc.toISOString().slice(0,19);
    }
    const startUTC = toUTCISOStringNoZ(startPKT);
    const endUTC = toUTCISOStringNoZ(endPKT);

    const url = `https://api.thingspeak.com/channels/${channelId}/feeds.json?start=${startUTC}&end=${endUTC}&results=8000`;

    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error('Network error: ' + res.status);
      const data = await res.json();
      if (!data.feeds) throw new Error('Invalid data format');
      return data.feeds;
    } catch(e) {
      tbody.innerHTML = '<tr><td colspan="5">Error loading data.</td></tr>';
      console.error(e);
      return [];
    }
  }

  function groupFeeds(feeds, intervalMins, dateVal) {
    const groups = {};
    feeds.forEach(feed => {
      if (!feed.created_at) return;
      const feedUTC = new Date(feed.created_at);
      const feedPKT = new Date(feedUTC.getTime() + 5*60*60000); // UTC+5

      if (feedPKT.toISOString().slice(0,10) !== dateVal) return;

      const h = feedPKT.getHours();
      const m = feedPKT.getMinutes();
      const slotMin = m - (m % intervalMins);
      const key = `${String(h).padStart(2,'0')}:${String(slotMin).padStart(2,'0')}`;

      if (!groups[key]) groups[key] = {temps:[], hums:[], firstTemp:null, firstHum:null};

      const temp = parseFloat(feed.field1);
      const hum = parseFloat(feed.field2);

      if (!isNaN(temp)) {
        groups[key].temps.push(temp);
        if (groups[key].firstTemp === null) groups[key].firstTemp = temp;
      }
      if (!isNaN(hum)) {
        groups[key].hums.push(hum);
        if (groups[key].firstHum === null) groups[key].firstHum = hum;
      }
    });

    return Object.entries(groups).sort((a,b)=>{
      const [hA,mA] = a[0].split(':').map(Number);
      const [hB,mB] = b[0].split(':').map(Number);
      return hA - hB || mA - mB;
    }).map(([time, data]) => {
      const avgT = data.temps.length ? (data.temps.reduce((a,b)=>a+b,0)/data.temps.length).toFixed(1) : '-';
      const avgH = data.hums.length ? (data.hums.reduce((a,b)=>a+b,0)/data.hums.length).toFixed(1) : '-';
      return {
        time,
        temp: data.firstTemp !== null ? data.firstTemp.toFixed(1) : '-',
        hum: data.firstHum !== null ? data.firstHum.toFixed(1) : '-',
        avgT,
        avgH
      };
    });
  }

  function updateHighLow(rows) {
    let high = -Infinity, low = Infinity;
    rows.forEach(r => {
      if (r.temp !== '-' && !isNaN(+r.temp)) {
        const t = +r.temp;
        if (t > high) high = t;
        if (t < low) low = t;
      }
    });
    highTempEl.textContent = high === -Infinity ? '-' : high.toFixed(1);
    lowTempEl.textContent = low === Infinity ? '-' : low.toFixed(1);
  }

  async function fetchAndRender() {
    const feeds = await fetchData();
    if (!feeds.length) {
      tbody.innerHTML = '<tr><td colspan="5">No data found for selected date.</td></tr>';
      highTempEl.textContent = '-';
      lowTempEl.textContent = '-';
      return;
    }
    const interval = parseInt(intervalSelect.value, 10);
    const dateVal = dateInput.value;
    const rows = groupFeeds(feeds, interval, dateVal);

    tbody.innerHTML = rows.length ? rows.map(r => `<tr>
      <td>${r.time}</td><td>${r.temp}</td><td>${r.hum}</td><td>${r.avgT}</td><td>${r.avgH}</td>
    </tr>`).join('') : '<tr><td colspan="5">No grouped data</td></tr>';

    updateHighLow(rows);
  }

  function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text(`Rehman Poultry Farm 29/11L - ${shedName}`, 10, 15);
    doc.setFontSize(12);
    doc.text(`Date: ${dateInput.value}`, 10, 22);
    doc.text(`High Temp: ${highTempEl.textContent} Â°C`, 10, 30);
    doc.text(`Low Temp: ${lowTempEl.textContent} Â°C`, 60, 30);

    doc.autoTable({
      head: [['Time','Temperature','Humidity','Avg Temp','Avg Humidity']],
      body: Array.from(tbody.rows).map(r => Array.from(r.cells).map(c => c.textContent)),
      startY: 40,
      theme: 'grid'
    });

    doc.save(`${shedName.replace(/\s+/g,'_')}_${dateInput.value}.pdf`);
  }

  fetchAndRender();
</script>
</body>
</html>
